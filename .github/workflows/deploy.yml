name: Deploy

on:
    workflow_run:
        workflows: ["Build", "Tests"]
        types: [completed]
        branches: [main]

jobs:
    deploy:
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        runs-on: ubuntu-latest
        concurrency:
            group: deploy-${{ github.ref }}
            cancel-in-progress: true
        steps:
            - name: Deploy via SSH
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.SSH_HOST }}
                  username: ${{ secrets.SSH_USERNAME }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  port: ${{ secrets.SSH_PORT }}
                  script: |
                      set -e
                      echo "=== Pulling code ==="
                      cd /var/www/pelican
                      git config --global --add safe.directory /var/www/pelican
                      git fetch origin
                      git reset --hard origin/main

                      echo "=== Composer install ==="
                      COMPOSER_ALLOW_SUPERUSER=1 composer install --no-dev --optimize-autoloader --no-interaction

                      echo "=== Bun update & build ==="
                      bun update --latest
                      bun x vite build

                      echo "=== Laravel maintenance ==="
                      php artisan down
                      chmod -R 755 storage/* bootstrap/cache
                      php artisan storage:link
                      php artisan optimize:clear
                      php artisan optimize
                      php artisan migrate --seed --force
                      chown -R www-data:www-data /var/www/pelican
                      php artisan queue:restart
                      php artisan up
                      echo "=== Deploy complete ==="
